"""
Date:        4/14/2025 
Class:       SignatureScanner
Description: This class is responsible for implmenting the SHA256
             signature based scanning functionality. This class inherits
             the parent scanner class, and utilizes the database_handler.
             The goal should be for this class to eventually output a 
             Scan_Result object to the DB.
"""
from structs import Scan_Result, File_Record
from scanners.scanner import Scanner
import utils
import os
import logging
logger = logging.getLogger(__name__)

class SignatureScanner(Scanner):
    
    def __init__(self, db_handler):
        super().__init__(db_handler)

    def __scan_file__(self, path):
        if os.path.isdir(path):
            raise Exception("Error expected file path but got directory instead")
        
        absolute_path = os.path.abspath(path)
        with open(absolute_path, 'rb') as file:
            file_bytes = file.read()
            file_hash = utils.hash_sha256(file_bytes)

        has_signature = self.db.search_signatures_table(file_hash)

        return File_Record(
            path=absolute_path,
            size_bytes=os.path.getsize(absolute_path),
            sha256=file_hash,
            is_malware= True if has_signature else False,

        )


    def scan(self, path) -> Scan_Result:
        return(self.__scan_file__(path))