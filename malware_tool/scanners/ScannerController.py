"""
Date:        4/18/2025 
Class:       ScannerController
Description: This class is responsible for managing all the different sub-scanners,
             and navigating through the user's file directories recursively.
"""
from scanners.signature_scanner import SignatureScanner
from scanners.HookScanner import HookScanner
from scanners.FileSizeScanner import FileSizeScanner
from structs import Scan_Overview, File_Scan_Report
from database_handler import Database_Handler
import os
import json
from typing import List

class ScannerController():
    def __init__(self):
        self.db_handler = Database_Handler()
        self.signature_scanner = SignatureScanner(self.db_handler)
        self.hook_scanner = HookScanner(self.db_handler)
        self.file_size_scanner = FileSizeScanner(self.db_handler)

    def __generate_scan_overview(self, file_scan_reports: List[File_Scan_Report], scan_path:str):
        files_scanned = [file_scan_report.path for file_scan_report in file_scan_reports]
        malicious_files = [file_scan_report.path for file_scan_report in file_scan_reports if file_scan_report.is_malware]

        return Scan_Overview(
            contains_malicious_files= len(malicious_files) > 0,
            scan_path= scan_path,
            files_scanned= json.dumps(files_scanned),
            malicous_files= json.dumps(malicious_files)
        )

    def health_scan(self, path):
        results = self.signature_scanner.scan(path)
        results += self.hook_scanner.scan()

        results += self.file_size_scanner.scan(results)

        scan_overview = self.__generate_scan_overview(
            results,
            scan_path=path
        )

        self.db_handler.insert_scan_overview(scan_overview)

        self.db_handler.insert_file_scan_reports(results)

        return scan_overview
    
    def file_scan(self, path):
        results = self.signature_scanner.scan(path)
        results += self.file_size_scanner.scan(results)

        scan_overview = self.__generate_scan_overview(
            results,
            scan_path=path
        )

        self.db_handler.insert_scan_overview(scan_overview)
        self.db_handler.insert_file_scan_reports(results)

        return scan_overview
    
    def process_scan(self):
        results = self.hook_scanner.scan()

        scan_overview = self.__generate_scan_overview(
            results,
            scan_path="Process Scan"
        )

        self.db_handler.insert_scan_overview(scan_overview)
        self.db_handler.insert_file_scan_reports(results)

        return scan_overview

    def generate_report(self, report:Scan_Overview, path):
        with open(path, "w") as f:
            f.write(f"Scan Path: {report.scan_path}\n")
            f.write(f"Contains Malicious Files: {report.contains_malicious_files}\n")
            f.write(f"Files Scanned: {report.files_scanned}\n")
            f.write(f"Malicious Files: {report.malicous_files}\n")
            f.write(f"Timestamp: {report.timestamp}\n")
    
        


